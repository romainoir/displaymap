<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Webcams + Refuges (enriched)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@5.10.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@5.10.0/dist/maplibre-gl.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }

    .cam-wrap { position: relative; width: 36px; height: 36px; }
    .cam-fov { position: absolute; left: -6px; top: -6px; width: 48px; height: 48px; border-radius: 50%; opacity: .35; pointer-events: none; z-index: 0; }
    .cam-marker { position: relative; width: 36px; height: 36px; border-radius: 50%; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,.25); background: #eee center/cover no-repeat; cursor: pointer; z-index: 1; }
    .cam-marker img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .cluster-marker { position: relative; width: 36px; height: 36px; border-radius: 6px; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,.25); background: #eee center/cover no-repeat; cursor: pointer; z-index: 1; }
    .cluster-marker img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .cluster-wrap { display: inline-flex; flex-direction: column; align-items: center; }
    .cluster-count { margin-top: 3px; padding: 1px 5px; border-radius: 999px; background: rgba(0,0,0,.75); color: #fff; font: 600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; backdrop-filter: blur(2px); pointer-events: none; }

    #hoverPreview { position: fixed; z-index: 999; pointer-events: none; opacity: 0; transform: translate(-50%,-100%) scale(.96); transition: opacity .12s ease, transform .12s ease; background: #000; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,.35); overflow: hidden; max-width: min(60vw, 640px); max-height: min(50vh, 360px); }
    #hoverPreview.open { opacity: 1; transform: translate(-50%,-100%) scale(1); }
    #hoverPreview img, #hoverPreview video { display: block; width: 100%; height: auto; }

    #viewer { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000; background: rgba(0,0,0,.6); }
    #viewer.open { display: flex; }
    #viewer .panel { background: #111; color: #fff; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.4); padding: 10px; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; gap: 8px; }
    #viewer header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 0 6px; }
    #viewer header .title { font: 600 15px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #viewer .main-image-container { position: relative; display: flex; align-items: center; justify-content: center; width: 800px; height: 600px; max-width: 85vw; max-height: 60vh; border-radius: 8px; }
    #viewer .main-image-container img { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; border-radius: 8px; }
    #viewer .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,.6); color: #fff; border: 0; cursor: pointer; font: 700 20px system-ui; transition: background 0.2s; z-index: 10; }
    #viewer .carousel-btn:hover { background: rgba(0,0,0,.85); }
    #viewer .carousel-btn.prev { left: 10px; }
    #viewer .carousel-btn.next { right: 10px; }
    #viewer .counter { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.7); color: #fff; padding: 4px 12px; border-radius: 999px; font: 600 12px system-ui; pointer-events: none; }
    #viewer .thumbnails { display: flex; gap: 8px; overflow-x: auto; padding: 8px 4px; max-width: 100%; scroll-behavior: smooth; justify-content: center; }
    #viewer .thumbnails::-webkit-scrollbar { height: 6px; }
    #viewer .thumbnails::-webkit-scrollbar-track { background: rgba(255,255,255,.1); border-radius: 3px; }
    #viewer .thumbnails::-webkit-scrollbar-thumb { background: rgba(255,255,255,.3); border-radius: 3px; }
    #viewer .thumbnails::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.5); }
    #viewer .thumb { width: 80px; height: 60px; border-radius: 6px; object-fit: cover; cursor: pointer; opacity: 0.6; transition: opacity 0.2s, transform 0.2s; border: 2px solid transparent; flex-shrink: 0; }
    #viewer .thumb:hover { opacity: 0.9; transform: scale(1.05); }
    #viewer .thumb.active { opacity: 1; border-color: #fff; }
    #viewer .open-link { position: absolute; right: 10px; top: 10px; width: 36px; height: 36px; border-radius: 8px; background: rgba(0,0,0,.65); display: grid; place-items: center; z-index: 11; }
    #viewer .open-link svg { width: 20px; height: 20px; fill: #fff; opacity: .95; }
    #viewer .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; padding: 4px 8px; line-height: 1; opacity: 0.8; transition: opacity 0.2s; }
    #viewer .close-btn:hover { opacity: 1; }
    .hidden { display: none !important; }

    /* Refuges */
    .hut-marker { position: relative; width: 28px; height: 28px; border-radius: 6px; overflow: hidden; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,.25); background: #2e7d32; display: grid; place-items: center; background-position:center; background-size:cover; }
    .hut-marker img { width: 70%; height: 70%; display: block; opacity: .95; }
    .hut-marker.is-closed { filter: grayscale(1) brightness(.8); }
    .hut-badge { position: absolute; right: -2px; top: -2px; font: 700 10px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background: #111; color:#fff; padding: 2px 4px; border-radius: 999px; border: 1px solid #fff; transform: translate(25%,-25%); }
  </style>
</head>
<body>
<div id="map"></div>
<div id="hoverPreview" aria-hidden="true"></div>
<div id="viewer" aria-hidden="true">
  <div class="panel">
    <header>
      <div class="title" id="viewerTitle">Détail</div>
      <button class="close-btn" onclick="document.getElementById('viewer').click()">×</button>
    </header>
    <div class="main-image-container" id="viewerContent"></div>
    <div class="thumbnails" id="viewerThumbs"></div>
  </div>
</div>

<script>
(function(){
  'use strict';
  var FALLBACK_ICON = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" fill="%23eee" stroke="%23999"/><path d="M6 16l12-8M8 9h1m6 6h1" stroke="%23999" /></svg>';
  var HUT_ICON = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 12l9-7 9 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 10v9h5v-6h4v6h5v-9" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');

  var startCenter = [2.2137, 46.2276], startZoom = 5, hadHash = false;
  var m = (location.hash || '').match(/^#([0-9.]+)\/(-?[0-9.]+)\/(-?[0-9.]+)$/);
  if (m) { startZoom = parseFloat(m[1]); startCenter = [parseFloat(m[3]), parseFloat(m[2])]; if (isFinite(startZoom) && isFinite(startCenter[0]) && isFinite(startCenter[1])) hadHash = true; }

  var map = new maplibregl.Map({ container:'map', style:'https://tiles.openfreemap.org/styles/liberty', center:startCenter, zoom:startZoom, renderWorldCopies:false });
  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  function updateHashLater(){ if (updateHashLater.t) cancelAnimationFrame(updateHashLater.t); updateHashLater.t = requestAnimationFrame(function(){ var z=map.getZoom().toFixed(1), c=map.getCenter(); location.replace('#'+z+'/'+c.lat.toFixed(5)+'/'+c.lng.toFixed(5)); }); }

  var THUMB_ON = 14.2, THUMB_OFF = 13.8;
  var thumbnailsOn = false;
  var markers = new Map();
  var clusterThumbCache = new Map();
  var lastSyncTime = 0, SYNC_DEBOUNCE = 50;

  var viewer = document.getElementById('viewer');
  var viewerContent = document.getElementById('viewerContent');
  var viewerTitle = document.getElementById('viewerTitle');
  var viewerThumbs = document.getElementById('viewerThumbs');

  function openViewer(props){
    viewerTitle.textContent = props.title || 'Détail';
    viewerContent.innerHTML = '';
    viewerThumbs.innerHTML = '';

    var photos = Array.isArray(props.photos) ? props.photos.filter(Boolean) : [];
    console.log('openViewer called with:', photos.length, 'photos');

    if (photos.length > 0) {
      var idx = 0;
      
      // Image principale
      var mainImg = document.createElement('img');
      mainImg.referrerPolicy = 'no-referrer';
      mainImg.alt = props.title || '';
      mainImg.style.display = 'block';
      
      // Bouton lien
      var linkBtn = document.createElement('a');
      linkBtn.className = 'open-link';
      linkBtn.href = props.url || '#';
      linkBtn.target = '_blank';
      linkBtn.rel = 'noopener';
      linkBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42L17.59 5H14V3z"/><path d="M5 5h6v2H7v10h10v-4h2v6H5z"/></svg>';
      
      // Compteur
      var counter = document.createElement('div');
      counter.className = 'counter';
      
      // Fonction pour changer d'image
      function showPhoto(newIdx) {
        idx = newIdx;
        mainImg.src = photos[idx];
        counter.textContent = (idx + 1) + '/' + photos.length;
        
        // Mettre à jour les miniatures actives
        var thumbs = viewerThumbs.querySelectorAll('.thumb');
        thumbs.forEach(function(t, i) {
          if (i === idx) t.classList.add('active');
          else t.classList.remove('active');
        });
        
        // Scroll vers la miniature active
        if (thumbs[idx]) {
          thumbs[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
      
      // Boutons navigation (seulement si plusieurs photos)
      if (photos.length > 1) {
        var prevBtn = document.createElement('button');
        prevBtn.className = 'carousel-btn prev';
        prevBtn.textContent = '‹';
        prevBtn.onclick = function() {
          showPhoto((idx - 1 + photos.length) % photos.length);
        };
        
        var nextBtn = document.createElement('button');
        nextBtn.className = 'carousel-btn next';
        nextBtn.textContent = '›';
        nextBtn.onclick = function() {
          showPhoto((idx + 1) % photos.length);
        };
        
        viewerContent.appendChild(prevBtn);
        viewerContent.appendChild(nextBtn);
        viewerContent.appendChild(counter);
        
        // Créer les miniatures
        photos.forEach(function(url, i) {
          var thumb = document.createElement('img');
          thumb.className = 'thumb';
          if (i === 0) thumb.classList.add('active');
          thumb.src = url;
          thumb.referrerPolicy = 'no-referrer';
          thumb.alt = 'Photo ' + (i + 1);
          
          // Clic pour mobile et desktop
          thumb.onclick = function() {
            showPhoto(i);
          };
          
          // Hover pour desktop uniquement (si pas tactile)
          thumb.onmouseenter = function() {
            // Vérifier si c'est un appareil tactile
            if (!('ontouchstart' in window)) {
              showPhoto(i);
            }
          };
          
          viewerThumbs.appendChild(thumb);
        });
      }
      
      viewerContent.appendChild(mainImg);
      viewerContent.appendChild(linkBtn);
      
      // Initialiser
      showPhoto(0);
      
    } else {
      // Pas de photos, afficher juste le poster
      var poster = props.thumb || (props.media && (props.media.hd || props.media.large || props.media.small));
      if (poster) {
        var img = document.createElement('img');
        img.referrerPolicy = 'no-referrer';
        img.src = poster;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '60vh';
        img.style.borderRadius = '8px';
        viewerContent.appendChild(img);
      }
    }

    viewer.classList.add('open');
    viewer.setAttribute('aria-hidden', 'false');
  }
  
  viewer.addEventListener('click', function(e){ 
    if (e.target === viewer) { 
      viewer.classList.remove('open'); 
      viewer.setAttribute('aria-hidden','true'); 
      viewerContent.innerHTML=''; 
      viewerThumbs.innerHTML='';
    } 
  });
  window.addEventListener('keydown', function(e){ if (e.key==='Escape') viewer.click(); });

  var hover = document.getElementById('hoverPreview');
  var hoverShown = false, lastMouse = {x:0,y:0};
  function showHover(props){ var best=(props.media&&(props.media.hd||props.media.large||props.media.small))||props.mediaUrl||props.thumb; if(!best) return hideHover(); hover.innerHTML=''; var img=document.createElement('img'); img.referrerPolicy='no-referrer'; img.src=best; hover.appendChild(img); hover.style.left=lastMouse.x+'px'; hover.style.top=lastMouse.y+'px'; hover.classList.add('open'); hoverShown=true; }
  function hideHover(){ if(!hoverShown) return; hover.classList.remove('open'); hoverShown=false; }
  window.addEventListener('mousemove', function(e){ lastMouse.x=e.clientX; lastMouse.y=e.clientY; if(hoverShown){ hover.style.left=e.clientX+'px'; hover.style.top=e.clientY+'px'; } });
  map.on('dragstart', hideHover); map.on('zoomstart', hideHover); map.on('movestart', hideHover);

  function preloadOk(url){ return new Promise(function(resolve){ if(!url) return resolve(false); var t=new Image(); t.referrerPolicy='no-referrer'; t.onload=function(){resolve(true)}; t.onerror=function(){resolve(false)}; t.src=url; }); }

  function makeFovDiv(bearingDeg, fovDeg){ var d=document.createElement('div'); d.className='cam-fov'; var span=Math.max(0,Math.min(360,(fovDeg||0))); d.style.backgroundImage='conic-gradient(rgba(0,0,0,0.35) 0deg '+span+'deg, transparent '+span+'deg 360deg)'; d.style.transform='rotate('+(bearingDeg - span/2)+'deg)'; return d; }

  function createCamMarker(f){
    var wrap=document.createElement('div'); wrap.className='cam-wrap'; var fovEl=makeFovDiv(Number(f.properties.bearing||0), Number(f.properties.fov||90)); wrap.appendChild(fovEl);
    var el=document.createElement('div'); el.className='cam-marker'; var src=f.properties.thumb || FALLBACK_ICON; var img=document.createElement('img'); img.src=src; img.alt=f.properties.title||'Webcam'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.onerror=function(){ img.onerror=null; img.src=FALLBACK_ICON; }; el.appendChild(img); wrap.appendChild(el);
    wrap.addEventListener('mouseenter', function(e){ lastMouse.x=e.clientX; lastMouse.y=e.clientY; showHover({ media:{}, mediaUrl:f.properties.thumb, thumb:f.properties.thumb }); });
    wrap.addEventListener('mousemove', function(e){ lastMouse.x=e.clientX; lastMouse.y=e.clientY; if(hoverShown){ hover.style.left=e.clientX+'px'; hover.style.top=e.clientY+'px'; } });
    wrap.addEventListener('mouseleave', hideHover);
    wrap.addEventListener('click', function(){ openViewer({ title:f.properties.title, url:f.properties.url, thumb:f.properties.thumb }); map.easeTo({ center:f.geometry.coordinates, zoom:Math.max(map.getZoom(),12), duration:500 }); });
    return new maplibregl.Marker({ element:wrap, anchor:'bottom' }).setLngLat(f.geometry.coordinates);
  }

  function createRefugeMarker(f){
    var p = f.properties || {};
    var thumb = p.thumbnail || (Array.isArray(p.photos) && p.photos[0]) || null;
    var el = document.createElement('div');
    el.className='hut-marker';
    if (thumb) {
      try { el.style.backgroundImage = 'url('+CSS.escape(thumb)+')'; }
      catch(e){ el.style.backgroundImage = 'url('+String(thumb).replace(/["']/g,'')+')'; }
      el.style.backgroundSize = 'cover';
      el.style.backgroundPosition = 'center';
    } else {
      var img=document.createElement('img'); img.src=HUT_ICON; img.alt='Refuge'; el.appendChild(img);
    }
    var status=(p.etat && (p.etat.valeur||'')).toLowerCase();
    if(status && (status.includes('ferm') || status.includes('détru') || status.includes('detru'))) el.classList.add('is-closed');
    var places = (p.places && (p.places.valeur!=null)) ? String(p.places.valeur) : '';
    if(places){ var b=document.createElement('div'); b.className='hut-badge'; b.textContent=places; el.appendChild(b); }
    
    // Ajout du hover pour les refuges
    el.addEventListener('mouseenter', function(e){ 
      lastMouse.x=e.clientX; 
      lastMouse.y=e.clientY; 
      if(thumb) showHover({ media:{}, mediaUrl:thumb, thumb:thumb }); 
    });
    el.addEventListener('mousemove', function(e){ 
      lastMouse.x=e.clientX; 
      lastMouse.y=e.clientY; 
      if(hoverShown){ 
        hover.style.left=e.clientX+'px'; 
        hover.style.top=e.clientY+'px'; 
      } 
    });
    el.addEventListener('mouseleave', hideHover);
    
    el.addEventListener('click', function(){
      // S'assurer que photos est un tableau
      var photos = p.photos;
      if (typeof photos === 'string') {
        try { photos = JSON.parse(photos); } catch(e) { photos = []; }
      }
      if (!Array.isArray(photos)) photos = [];
      
      console.log('Opening refuge:', p.nom, 'Photos:', photos.length);
      openViewer({ 
        title: p.nom || 'Refuge', 
        url: p.lien || '', 
        thumb: thumb, 
        photos: photos 
      });
      map.easeTo({ center:f.geometry.coordinates, zoom:Math.max(map.getZoom(),12), duration:500 });
    });
    return new maplibregl.Marker({ element:el, anchor:'bottom' }).setLngLat(f.geometry.coordinates);
  }

  function createClusterMarkerWebcams(f){
    var cid=f.properties.cluster_id; var el=document.createElement('div'); el.className='cluster-wrap'; var icon=document.createElement('div'); icon.className='cluster-marker';
    var cacheKey='webcams:'+cid; var cached=clusterThumbCache.get(cacheKey);
    if(cached){ var im=document.createElement('img'); im.src=cached; im.loading='lazy'; im.referrerPolicy='no-referrer'; icon.appendChild(im); }
    else {
      map.getSource('webcams').getClusterLeaves(cid, 8, 0).then(function(leaves){
        function pickNext(idx){ if(idx>=leaves.length){ var imF=document.createElement('img'); imF.src=FALLBACK_ICON; icon.appendChild(imF); clusterThumbCache.set(cacheKey, FALLBACK_ICON); return; }
          var leaf=leaves[idx]; var u=leaf && leaf.properties && leaf.properties.thumb; preloadOk(u).then(function(ok){ if(ok){ clusterThumbCache.set(cacheKey,u); var im2=document.createElement('img'); im2.src=u; im2.loading='lazy'; im2.referrerPolicy='no-referrer'; icon.appendChild(im2); } else { pickNext(idx+1); } });
        }
        pickNext(0);
      }).catch(function(){ var im3=document.createElement('img'); im3.src=FALLBACK_ICON; icon.appendChild(im3); clusterThumbCache.set(cacheKey, FALLBACK_ICON); });
    }
    var badge=document.createElement('div'); badge.className='cluster-count'; badge.textContent=String(f.properties.point_count);
    el.appendChild(icon); el.appendChild(badge);
    el.addEventListener('click', function(){ map.getSource('webcams').getClusterExpansionZoom(cid).then(function(z){ map.easeTo({ center:f.geometry.coordinates, zoom:z, duration:500 }); }); });
    return new maplibregl.Marker({ element:el, anchor:'bottom' }).setLngLat(f.geometry.coordinates);
  }

  function createClusterMarkerRefuges(f){
    var cid=f.properties.cluster_id; var el=document.createElement('div'); el.className='cluster-wrap'; var icon=document.createElement('div'); icon.className='cluster-marker';
    var im=document.createElement('img'); im.src=HUT_ICON; icon.appendChild(im);
    var badge=document.createElement('div'); badge.className='cluster-count'; badge.textContent=String(f.properties.point_count);
    el.appendChild(icon); el.appendChild(badge);
    el.addEventListener('click', function(){ map.getSource('refuges').getClusterExpansionZoom(cid).then(function(z){ map.easeTo({ center:f.geometry.coordinates, zoom:z, duration:500 }); }); });
    return new maplibregl.Marker({ element:el, anchor:'bottom' }).setLngLat(f.geometry.coordinates);
  }

  function syncDomMarkers(){
    var now=Date.now(); if(now-lastSyncTime < SYNC_DEBOUNCE && !syncDomMarkers.force) return; lastSyncTime=now; syncDomMarkers.force=false;
    var z=map.getZoom(); var wantThumbs = z > (thumbnailsOn ? THUMB_OFF : THUMB_ON);
    if(wantThumbs !== thumbnailsOn){ thumbnailsOn = wantThumbs; markers.forEach(function(m){ m.remove(); }); markers.clear(); hover.classList.remove('open'); syncDomMarkers.force=true; return; }

    var next=new Set(); var canvas=map.getCanvas(); var bbox=[[0,0],[canvas.width,canvas.height]];
    var clustersML = map.queryRenderedFeatures(bbox, { layers:['ml-clusters'] }) || [];
    var pointsML   = map.queryRenderedFeatures(bbox, { layers:['ml-unclustered'] }) || [];
    var clustersRF = map.queryRenderedFeatures(bbox, { layers:['rf-clusters'] }) || [];
    var pointsRF   = map.queryRenderedFeatures(bbox, { layers:['rf-unclustered'] }) || [];

    var totalClusters = clustersML.length + clustersRF.length;
    var totalPoints   = pointsML.length + pointsRF.length;
    var mode = thumbnailsOn ? 'points' : 'clusters';
    if(mode==='points'   && totalPoints===0 && totalClusters>0) mode='clusters';
    if(mode==='clusters' && totalClusters===0 && totalPoints>0) mode='points';

    if(mode==='clusters'){
      var seenCw=new Set();
      for(var i=0;i<clustersML.length;i++){ var fc=clustersML[i]; if(!fc.properties||!('cluster_id' in fc.properties)) continue; var key='c-web-'+fc.properties.cluster_id; if(seenCw.has(key)) continue; seenCw.add(key); next.add(key);
        if(!markers.has(key)) { markers.set(key, createClusterMarkerWebcams(fc).addTo(map)); }
        else { var mk=markers.get(key), cur=mk.getLngLat(), nc=fc.geometry.coordinates; var d=Math.hypot(cur.lng-nc[0], cur.lat-nc[1]); if(d>0.0001) mk.setLngLat(nc); }
      }
      var seenCr=new Set();
      for(var j=0;j<clustersRF.length;j++){ var fr=clustersRF[j]; if(!fr.properties||!('cluster_id' in fr.properties)) continue; var keyR='c-ref-'+fr.properties.cluster_id; if(seenCr.has(keyR)) continue; seenCr.add(keyR); next.add(keyR);
        if(!markers.has(keyR)) { markers.set(keyR, createClusterMarkerRefuges(fr).addTo(map)); }
        else { var mkR=markers.get(keyR), curR=mkR.getLngLat(), ncR=fr.geometry.coordinates; var dR=Math.hypot(curR.lng-ncR[0], curR.lat-ncR[1]); if(dR>0.0001) mkR.setLngLat(ncR); }
      }
    } else {
      var seenPw=new Set();
      for(var k=0;k<pointsML.length;k++){ var pf=pointsML[k]; var id=(pf.properties && (pf.properties.id || JSON.stringify(pf.geometry.coordinates))) || ('idx'+k); var keyP='p-web-'+id; if(seenPw.has(keyP)) continue; seenPw.add(keyP); next.add(keyP);
        if(!markers.has(keyP)) { markers.set(keyP, createCamMarker(pf).addTo(map)); }
        else { var mkP=markers.get(keyP), curP=mkP.getLngLat(), ncP=pf.geometry.coordinates; var dP=Math.hypot(curP.lng-ncP[0], curP.lat-ncP[1]); if(dP>0.0001) mkP.setLngLat(ncP); }
      }
      var seenPr=new Set();
      for(var t=0;t<pointsRF.length;t++){ var pr=pointsRF[t]; var idr=(pr.properties && (pr.properties.id || JSON.stringify(pr.geometry.coordinates))) || ('idxR'+t); var keyR2='p-ref-'+idr; if(seenPr.has(keyR2)) continue; seenPr.add(keyR2); next.add(keyR2);
        if(!markers.has(keyR2)) { markers.set(keyR2, createRefugeMarker(pr).addTo(map)); }
        else { var mkR2=markers.get(keyR2), curR2=mkR2.getLngLat(), ncR2=pr.geometry.coordinates; var dR2=Math.hypot(curR2.lng-ncR2[0], curR2.lat-ncR2[1]); if(dR2>0.0001) mkR2.setLngLat(ncR2); }
      }
    }

    markers.forEach(function(m,key){ if(!next.has(key)){ m.remove(); markers.delete(key); } });
  }

  function initDomOverlays(){
    var pending=false, syncTimeout=null;
    function requestSync(immediate){ if(syncTimeout) clearTimeout(syncTimeout); if(immediate){ syncDomMarkers.force=true; syncDomMarkers(); return; } if(pending) return; pending=true; syncTimeout=setTimeout(function(){ requestAnimationFrame(function(){ pending=false; syncDomMarkers(); }); }, SYNC_DEBOUNCE); }
    syncDomMarkers.force=true; syncDomMarkers();
    map.on('move', function(){ requestSync(false); });
    map.on('zoom', function(){ requestSync(false); });
    map.on('idle', function(){ requestSync(true); });
    map.on('sourcedata', function(e){ if(e && (e.sourceId==='webcams' || e.sourceId==='refuges') && e.isSourceLoaded){ requestSync(true); } });
  }

  map.on('load', function(){
    fetch('skaping_webcam.json').then(r=>r.json()).then(function(data){
      var features = (function normalizeToFeatures(json){
        if(json && json.type==='FeatureCollection' && Array.isArray(json.features)){
          return json.features.filter(function(f){ return f && f.geometry && f.geometry.type==='Point'; }); }
        var out=[]; if(Array.isArray(json)){ for(var i=0;i<json.length;i++){ var item=json[i]; var lon=parseFloat(item.longitude!=null?item.longitude:item.lon); var lat=parseFloat(item.latitude!=null?item.latitude:item.lat); if(!isFinite(lon)||!isFinite(lat)) continue; var povs=Array.isArray(item.point_of_views)?item.point_of_views:[]; var pov=null; for(var k=0;k<povs.length;k++){ if(povs[k] && povs[k].type==='image'){ pov=povs[k]; break; } } if(!pov && povs.length) pov=pov||{}; var title=(pov && (pov.title)) || item.label || 'Webcam'; var url=(pov && pov.url) || '#'; var thumb=(pov && ((pov.type==='video'&&pov.preview&&pov.preview.thumb)?pov.preview.thumb:(pov.latest_media&&pov.latest_media.thumb&&!/\.mp4$/i.test(pov.latest_media.thumb))?pov.latest_media.thumb:(pov.preview&&pov.preview.thumb)?pov.preview.thumb:'')) || '';
          var bearing=parseFloat((pov&&pov.bearing)!=null?pov.bearing:(pov&&pov.direction)!=null?pov.direction:(pov&&pov.heading)!=null?pov.heading:(pov&&pov.azimuth)!=null?pov.azimuth:(item.bearing!=null?item.bearing:item.direction)); if(!isFinite(bearing)) bearing=0;
          var fov=parseFloat((pov&&pov.fov)!=null?pov.fov:(pov&&pov.field_of_view)!=null?pov.field_of_view:(pov&&pov.angle)!=null?pov.angle:(item.fov!=null?item.fov:item.field_of_view)); if(!isFinite(fov)){ var pano=!!(pov&&pov.panoramic||pov&&pov.panorama||item.panoramic||item.panorama); var half=!!(pov&&pov.half||item.half||pov&&pov.semicircle); fov=pano?360:(half?180:90); }
          out.push({ type:'Feature', geometry:{ type:'Point', coordinates:[lon,lat] }, properties:{ id:String(item.id||(title+':'+lon+','+lat)), title:title, url:url, place:(item.label||item.address||''), thumb:thumb, bearing:bearing, fov:fov } }); }
        }
        return out;
      })(data);
      if(!features.length){ console.warn('No webcam points found in skaping_webcam.json'); return; }
      var fc={ type:'FeatureCollection', features:features };
      map.addSource('webcams', { type:'geojson', data:fc, cluster:true, clusterMaxZoom:14, clusterRadius:60 });
      map.addLayer({ id:'ml-clusters', type:'circle', source:'webcams', filter:['has','point_count'], paint:{ 'circle-radius':1, 'circle-opacity':0 } });
      map.addLayer({ id:'ml-unclustered', type:'circle', source:'webcams', filter:['!', ['has','point_count']], paint:{ 'circle-radius':1, 'circle-opacity':0 } });

      // Refuges — utiliser le GeoJSON ENRICHED
      fetch('refuges_enriched.json').then(r=>r.json()).then(function(refData){
        map.addSource('refuges', { type:'geojson', data:refData, cluster:true, clusterMaxZoom:14, clusterRadius:60 });
        map.addLayer({ id:'rf-clusters', type:'circle', source:'refuges', filter:['has','point_count'], paint:{ 'circle-radius':1, 'circle-opacity':0 } });
        map.addLayer({ id:'rf-unclustered', type:'circle', source:'refuges', filter:['!', ['has','point_count']], paint:{ 'circle-radius':1, 'circle-opacity':0 } });

        initDomOverlays();

        if(!hadHash){
          var b=new maplibregl.LngLatBounds();
          features.forEach(function(ft){ b.extend(ft.geometry.coordinates); });
          (refData.features||[]).forEach(function(ft){ if(ft && ft.geometry && ft.geometry.type==='Point'){ b.extend(ft.geometry.coordinates); } });
          map.fitBounds(b, { padding:60, maxZoom:11 });
        }
      });
    }).catch(function(err){ console.error('Failed to load skaping_webcam.json', err); });
  });

  map.on('moveend', updateHashLater); map.on('zoomend', updateHashLater);
  map.on('error', function(e){ console.error('MapLibre error:', (e && e.error) || e); });
})();
</script>
</body>
</html>